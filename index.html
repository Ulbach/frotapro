<!DOCTYPE html><!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Frota Pro | Gestão de Veículos</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter',sans-serif;background:#F8FAFC;color:#1E293B;margin:0;-webkit-tap-highlight-color:transparent}
.header-container{background-image:linear-gradient(rgba(0,0,0,.3),rgba(15,23,42,.9)),url('https://images.unsplash.com/photo-1541899481282-d53bffe3c35d?auto=format&fit=crop&q=80&w=800');background-size:cover;background-position:center;border-bottom-left-radius:3rem;border-bottom-right-radius:3rem;height:180px}
.loader{border:4px solid #E2E8F0;border-top:4px solid #10B981;border-radius:50%;width:40px;height:40px;margin:2rem auto;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.glass-btn{background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:all .2s}
.glass-btn:active{background:rgba(255,255,255,.4)}
.action-card{background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.05);border-radius:2rem;transition:transform .2s}
.action-card:active{transform:scale(.95)}
.status-pill{background:#F0FDF4;color:#10B981;font-size:10px;font-weight:800;padding:6px 12px;border-radius:10px;text-transform:uppercase}
.status-pill-out{background:#FEF2F2;color:#EF4444}
#root:empty::before{content:"";display:block;width:30px;height:30px;border:3px solid #E2E8F0;border-top:3px solid #10B981;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);animation:spin 1s linear infinite}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
select,input{font-size:14px!important;font-weight:500!important}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useCallback,useMemo} = React;
const getUrl=()=>localStorage.getItem('FROTA_SCRIPT_URL')||'';
const isValidUrl=u=>u.includes('script.google.com')&&u.includes('/exec');
const jsonp=(url,cb)=>new Promise((res,rej)=>{const s=document.createElement('script');window[cb]=d=>{res(d);delete window[cb];s.remove()};s.src=url;s.onerror=()=>{rej();s.remove()};document.head.appendChild(s)};

// ---------- NOVO: SALVA SEM CORS ----------
const sheetsService={
getListas:async()=>{const u=getUrl();if(!u)return{veiculos:[],motoristas:[],segurancas:[]};try{return await jsonp(`${u}?action=getlistas&_ts=${Date.now()}`,'listaCallback')}catch{return{veiculos:[],motoristas:[],segurancas:[]}}},
getHistorico:async()=>{const u=getUrl();if(!u)return[];try{const d=await jsonp(`${u}?action=gethistorico&_ts=${Date.now()}`,'historicoCallback');return Array.isArray(d)?d:[]}catch{return[]}},
salvar:async(dados)=>{const u=getUrl();if(!u)return!1;return new Promise(res=>{window.addEventListener('message',function ok(e){if(e.data&&typeof e.data.ok==='boolean'){res(e.data.ok);window.removeEventListener('message',ok)}},false);const img=new Image();img.src=`${u}?action=salvar&data=${encodeURIComponent(JSON.stringify(dados))}`})}
};

const Dashboard=({listas,historico,onAction,onRefresh})=>{
const historicoMemo=useMemo(()=>historico.slice().reverse().slice(0,5),[historico]);
const fmt=d=>d?new Date(d).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}):'--/-- --:--';
return (
<div className="px-6 mt-14 space-y-8 pb-10">
<div className="grid grid-cols-2 gap-4">
<button onClick={()=>onAction('SAIDA')} className="action-card p-6 flex flex-col items-center gap-4 text-center border border-white"><div className="w-14 h-14 bg-rose-50 text-rose-500 rounded-3xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></div><span className="text-[11px] font-black uppercase tracking-widest text-slate-700">Reg. Saída</span></button>
<button onClick={()=>onAction('RETORNO')} className="action-card p-6 flex flex-col items-center gap-4 text-center border border-white"><div className="w-14 h-14 bg-emerald-50 text-emerald-500 rounded-3xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></div><span className="text-[11px] font-black uppercase tracking-widest text-slate-700">Reg. Entrada</span></button>
</div>
<div className="space-y-4">
<div className="flex justify-between items-center px-2"><div className="flex items-center gap-2 opacity-40"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><h2 className="text-[10px] font-black uppercase tracking-widest">Movimentação (Top 5)</h2></div><button onClick={onRefresh} className="text-slate-300 hover:text-emerald-500 transition-transform active:rotate-180"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></button></div>
<div className="space-y-3">{historicoMemo.map((log,i)=>(
<div key={i} className="bg-white p-5 rounded-[1.8rem] flex items-center gap-4 shadow-sm border border-white">
<div className="w-12 h-12 bg-slate-50 text-slate-400 rounded-2xl flex items-center justify-center shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 16l-4-4-4 4"></path><line x1="18" y1="8" x2="6" y2="8"></line><line x1="6" y1="16" x2="18" y2="16"></line></svg></div>
<div className="flex-1 min-w-0">
<h3 className="font-bold text-slate-800 text-[13px] uppercase tracking-tight truncate">{log.veiculo}</h3>
<p className="text-[10px] text-slate-400 font-bold uppercase truncate mb-1">{log.motorista}</p>
<div className="flex items-center gap-1.5 opacity-60"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span className="text-[9px] font-bold text-slate-500 uppercase">{fmt(log.status==='FORA'?log.datasaida:log.dataretorno)}</span></div>
</div>
<div className={`status-pill ${log.status==='FORA'?'status-pill-out':''}`}>{log.status==='FORA'?'Em Uso':'Pátio'}</div>
</div>))}{!historicoMemo.length&&<p className="text-center text-[10px] text-slate-400 font-bold">Nenhum registro encontrado</p>}</div>
</div>
</div>
);};
const Formulario=({tipo,listas,historico,onSucesso,onVoltar})=>{
const [loading,setLoading]=useState(false);
const [formData,setFormData]=useState({veiculo:'',motorista:'',seguranca:'',km:'',destino:''});
const [err,setErr]=useState('');
const veiculosFiltrados=useMemo(()=>{const fora=historico.filter(h=>h.status==='FORA').map(h=>h.veiculo);return tipo==='SAIDA'?listas.veiculos.filter(v=>!fora.includes(v)):listas.veiculos.filter(v=>fora.includes(v))},[tipo,listas.veiculos,historico]);
const kmAnterior=useMemo(()=>{if(!formData.veiculo)return null;const entries=historico.filter(h=>h.veiculo===formData.veiculo);if(!entries.length)return null;const last=entries[entries.length-1];return last.status==='FORA'?last.kmretorno:last.kmsaida},[formData.veiculo,historico]);
const isKmInvalido=useMemo(()=>kmAnterior!==null&&formData.km&&Number(formData.km)<Number(kmAnterior),[formData.km,kmAnterior]);
useEffect(()=>{if(tipo==='RETORNO'&&formData.veiculo){const lastOut=historico.slice().reverse().find(h=>h.veiculo===formData.veiculo&&h.status==='FORA');if(lastOut)setFormData(p=>({...p,motorista:lastOut.motorista||'',seguranca:lastOut.seguranca||''}))}},[formData.veiculo,tipo,historico]);
const handleSubmit
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Frota Pro | Gestão de Veículos</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter',sans-serif;background:#F8FAFC;color:#1E293B;margin:0;-webkit-tap-highlight-color:transparent}
.header-container{background-image:linear-gradient(rgba(0,0,0,.3),rgba(15,23,42,.9)),url('https://images.unsplash.com/photo-1541899481282-d53bffe3c35d?auto=format&fit=crop&q=80&w=800');background-size:cover;background-position:center;border-bottom-left-radius:3rem;border-bottom-right-radius:3rem;height:180px}
.loader{border:4px solid #E2E8F0;border-top:4px solid #10B981;border-radius:50%;width:40px;height:40px;margin:2rem auto;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.glass-btn{background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:all .2s}
.glass-btn:active{background:rgba(255,255,255,.4)}
.action-card{background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.05);border-radius:2rem;transition:transform .2s}
.action-card:active{transform:scale(.95)}
.status-pill{background:#F0FDF4;color:#10B981;font-size:10px;font-weight:800;padding:6px 12px;border-radius:10px;text-transform:uppercase}
.status-pill-out{background:#FEF2F2;color:#EF4444}
#root:empty::before{content:"";display:block;width:30px;height:30px;border:3px solid #E2E8F0;border-top:3px solid #10B981;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);animation:spin 1s linear infinite}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
select,input{font-size:14px!important;font-weight:500!important}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useCallback,useMemo} = React;
const getUrl=()=>localStorage.getItem('FROTA_SCRIPT_URL')||'';
const isValidUrl=u=>u.includes('script.google.com')&&u.includes('/exec');
const jsonp=(url,cb)=>new Promise((res,rej)=>{const s=document.createElement('script');window[cb]=d=>{res(d);delete window[cb];s.remove()};s.src=url;s.onerror=()=>{rej();s.remove()};document.head.appendChild(s)};

// ---------- NOVO: SALVA SEM CORS ----------
const sheetsService={
getListas:async()=>{const u=getUrl();if(!u)return{veiculos:[],motoristas:[],segurancas:[]};try{return await jsonp(`${u}?action=getlistas&_ts=${Date.now()}`,'listaCallback')}catch{return{veiculos:[],motoristas:[],segurancas:[]}}},
getHistorico:async()=>{const u=getUrl();if(!u)return[];try{const d=await jsonp(`${u}?action=gethistorico&_ts=${Date.now()}`,'historicoCallback');return Array.isArray(d)?d:[]}catch{return[]}},
salvar:async(dados)=>{const u=getUrl();if(!u)return!1;return new Promise(res=>{window.addEventListener('message',function ok(e){if(e.data&&typeof e.data.ok==='boolean'){res(e.data.ok);window.removeEventListener('message',ok)}},false);const img=new Image();img.src=`${u}?action=salvar&data=${encodeURIComponent(JSON.stringify(dados))}`})}
};

const Dashboard=({listas,historico,onAction,onRefresh})=>{
const historicoMemo=useMemo(()=>historico.slice().reverse().slice(0,5),[historico]);
const fmt=d=>d?new Date(d).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}):'--/-- --:--';
return (
<div className="px-6 mt-14 space-y-8 pb-10">
<div className="grid grid-cols-2 gap-4">
<button onClick={()=>onAction('SAIDA')} className="action-card p-6 flex flex-col items-center gap-4 text-center border border-white"><div className="w-14 h-14 bg-rose-50 text-rose-500 rounded-3xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></div><span className="text-[11px] font-black uppercase tracking-widest text-slate-700">Reg. Saída</span></button>
<button onClick={()=>onAction('RETORNO')} className="action-card p-6 flex flex-col items-center gap-4 text-center border border-white"><div className="w-14 h-14 bg-emerald-50 text-emerald-500 rounded-3xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></div><span className="text-[11px] font-black uppercase tracking-widest text-slate-700">Reg. Entrada</span></button>
</div>
<div className="space-y-4">
<div className="flex justify-between items-center px-2"><div className="flex items-center gap-2 opacity-40"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><h2 className="text-[10px] font-black uppercase tracking-widest">Movimentação (Top 5)</h2></div><button onClick={onRefresh} className="text-slate-300 hover:text-emerald-500 transition-transform active:rotate-180"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 
